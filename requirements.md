基于 WireGuard 的 SD-WAN (Hub-and-Spoke) 项目需求文档

项目背景与使用场景

本项目旨在构建一个基于 WireGuard 的 SD-WAN 解决方案，实现企业内部网络和边缘设备的安全互联。使用场景包括企业内网互联和分支/边缘节点接入，为各地分支机构、远程设备等提供加密的VPN连接。SD-WAN通过软件定义网络（SDN）技术将广域网管理集中化，具有灵活、简单、成本低的特点 ￼。现有SD-WAN方案（如 Aruba EdgeConnect）结合路由、防火墙、优化等组件，能在异构网络中实现企业级性能与安全 ￼。参考这些思路，新的项目也应提供集中化控制、策略下发及多链路接入的能力，以满足分布式网络的需求。与此同时，当前已有包括 WireGuard、Tailscale、ZeroTier 等在内的多种开源项目可用于异地组网，可为本项目提供借鉴。

性能与可扩展性需求
	•	大规模节点支持： 系统需支持千级以上VPN节点数，同时保证管理和转发性能。如开源Netmaker可扩展至企业级规模 ￼。
	•	自动化配置： 通过集中式控制器自动生成并下发WireGuard配置（包括密钥对、地址分配等），如wg-meshconf采用CSV/CLI方式管理Peer信息。本方案可进一步实现无缝化和自动化。
	•	集中管理： 通过集中配置接口（Web UI/API），统一管理网关节点和密钥，简化运维。WireGuard本身配置较简单，但手工维护大规模节点困难，因此需要自动化工具实现批量配置。
	•	容灾与高可用： 多个集群服务器（Hub）部署在不同故障域（可用区/数据中心），通过负载均衡提供单一入口。Azure上的WireGuard高可用案例表明：在至少两个可用区部署WireGuard服务器并通过云LB转发流量，可实现故障自动切换 ￼ ￼。本项目需设计主备机制或多活架构，确保单点故障时业务不中断。
	•	安全性： 利用WireGuard的现代加密和简洁协议提供高安全性。每个节点使用公私钥对认证，私钥仅存本地，公钥由控制器管理 ￼。可选集成ACL、OAuth等访问控制机制（如Netmaker支持ACL和OAuth ￼），满足细粒度访问和管理需求。

管理界面与操作方式
	•	Web UI： 需要提供图形化的Web管理界面，方便集中查看和操作。已有项目WireGuard Easy等提供了直观的Web UI来管理WireGuard客户端，例如下面的界面示例：
图：WireGuard Easy 提供的 Web 管理界面示例，支持客户端创建、删除、二维码生成及连接状态监控等功能。
新项目的管理界面应类似地支持节点注册/撤销、密钥管理、流量监控、拓扑视图等功能，提升可用性与易用性。同时支持后台API和命令行操作，以便自动化集成。
	•	自动化API： 提供RESTful API，支持集成到配置管理或CI/CD系统中，实现批量操作和自动部署。控制器可通过API下发配置并驱动每个节点应用更新。
	•	多语言支持： 界面可考虑多语言（如中英双语）支持，便于国际化部署。支持在任意现代浏览器上访问。

部署环境与技术选型
	•	运行环境： 设计为在 Linux（Ubuntu）服务器上部署，推荐使用 Docker 容器化部署以简化安装和升级，也可支持 Kubernetes 等容器编排系统。控制器和服务组件采用容器化发布。
	•	技术栈： 后端可选用高性能语言（如Go、Rust）编写，以充分利用并发和系统资源；也可用Python等进行快速开发。用户界面可用主流前端框架（如React/Vue）或基于现有UI库构建。关键点是WireGuard配置生成可通过库或系统调用实现。现有项目Netmaker采用Go并包含集成的Web UI和CLI ￼ ￼。
	•	存储与数据库： 节点和网络的配置数据需存储在数据库中（关系型或NoSQL）。应支持数据持久化与复制，确保配置数据高可用。
	•	容器化部署： 示例项目WireGuard Easy即通过Docker Compose部署，提供全量集成。本项目各组件也应提供Docker镜像，方便在Ubuntu服务器或云主机上以容器形式部署。

核心功能需求
	•	拓扑管理： 支持Hub-and-Spoke模式，即一个或多个Hub节点与多个Spoke节点的Star型拓扑。Hub节点负责不同Spoke之间的路由转发，简化直连需求。可扩展支持混合Mesh连接，但以Hub为中心的管理策略为主。
	•	节点管理： 节点注册/注销，自动为新节点生成WireGuard密钥对（或用户提供种子），并配置IP地址分配。参考wg-meshconf需要指定节点名称、地址、端点等信息。新系统可从Excel/CSV或直接通过Web表单/CLI输入节点列表，并生成对应的WG配置。
	•	配置下发： 生成的WireGuard配置文件需自动下发到各节点（可通过推送或拉取方式）。例如每个Spoke节点运行一个轻量代理守护进程（类似Netmaker的netclient），定期从控制器拉取配置并应用 ￼。这样无需手工复制文件，提高自动化程度。
	•	访问控制： 支持设置ACL规则或分组策略，控制不同节点或网络段之间的连通性。Netmaker即支持访问控制列表功能 ￼。可配置哪些节点允许互访，或限定只允许与Hub通信。
	•	监控与日志： 实时监控各节点的连接状态、流量统计（如WireGuard的Rx/Tx字节数）。提供日志记录功能，方便排障。监控数据可通过Grafana/Prometheus等可视化工具展示。
	•	高可用性： 支持配置多个Hub节点。客户端可使用负载均衡地址（LB地址）或备用Hub，当主Hub不可用时切换到其他Hub继续连接 ￼ ￼。后端存储和服务可部署主备模式确保控制器高可用。
	•	安全性： 私钥仅存于本地节点，通信经加密通道进行。在Web UI/CLI中不暴露私钥。支持预共享密钥（PSK）选项以增强安全（可选）。HTTPS/TLS加密控制面通信，保障后台API安全。

系统架构设计

系统采用集中式控制平面 + 分布式数据平面的SDN模式 ￼。控制平面由集中服务器（Controller/Orchestrator）组成，负责：
	•	管理节点注册、生成密钥对、维护配置数据库；
	•	提供Web UI和API供管理员操作，进行网络拓扑和策略的集中配置 ￼。
数据平面由各个WireGuard实例组成：每个节点（Hub或Spoke）运行 WireGuard 内核模块进行加密通信。Spoke节点通过与Hub的隧道将流量转发给其它Spoke。节点上的代理程序负责接受控制器下发的配置并调用wg-quick或API创建WireGuard接口。

各组件通信示意：
	•	控制器集群： 多台控制器节点保持配置数据同步（如使用etcd或数据库主备）。提供Web服务和API。
	•	节点代理（Agent）： 部署在Spoke节点上（及可选的Hub节点），负责自动注册到控制器、拉取配置并启动WireGuard隧道 ￼。
	•	负载均衡器： 对外提供虚拟IP或域名（如果需要），将流量分发到可用的Hub节点，实现高可用入口 ￼。
	•	拓扑管理模块： 在控制器中保存拓扑信息（Hub/Spoke关系），并动态更新WireGuard路由规则，确保各节点间可达。支持多Hub集群（即多个集中点）以增强容灾能力。

安全性与高可用性
	•	加密和认证： WireGuard天然使用现代加密，且所有Peer需要预配置对端公钥才能通信。系统应确保每个节点私钥不外泄，只在节点本地生成和使用。可选集成PSK或更高级的认证机制。
	•	多区容灾： 按照高可用最佳实践，在不同可用区或数据中心部署多个Hub。WireGuard客户端使用统一的LB地址，当一台Hub不可用时会自动切换到另一台 ￼ ￼。例如 Azure 示例中，将两台WG服务器置于不同可用区，并使用负载均衡器对外提供单一IP，可无感知地实现故障切换 ￼ ￼。
	•	数据高可用： 控制器后端配置数据库应做主从或多副本部署，避免单点故障。关键配置变更需持久化备份。
	•	监控与告警： 实时监控WireGuard接口状态和系统健康，节点离线或链路异常时触发告警。可通过Heartbeat/心跳、日志等机制检测故障并进行流量重路由。

参考现有方案与启示
	•	wg-meshconf： 该工具可自动生成WireGuard全网Mesh配置。其经验显示，通过预先定义节点信息表（CSV/JSON）可以自动批量生成配置文件。不过wg-meshconf偏向全网Mesh，不含Web界面，适合作为生成配置文件的基础参考。
	•	WireGuard Config Generator： 一个Web工具支持Hub-and-Spoke和Mesh拓扑。可借鉴其配置生成思路和前端设计。
	•	Netmaker： 开源SD-WAN平台，自动化构建数据中心、云与边缘间的虚拟网络 ￼。它提供集成的管理UI、站点到站点链接、ACL等功能 ￼ ￼，可作为架构和功能参考。例如“Admin UI”、“Site-to-Site”、“Private DNS”等特性展现了可用性和灵活性方向 ￼。Netmaker的客户端（Netclient）守护进程在节点上管理WireGuard连接 ￼，可启发本项目的Agent设计思路。
	•	WireGuard Easy： Docker化Web UI工具，一键部署WireGuard服务并管理客户端。其简单易用的Web管理界面证明了集成式Docker发布的可行性。我们可参考其容器化部署和前端交互设计。
	•	商业SD-WAN： 像Aruba EdgeConnect 等商用SD-WAN平台，展示了集中控制、流量优化、策略分发等功能 ￼。尽管这些平台专有，但在构建方案时应考虑如多链路接入、动态路径选择等高级特性。



基于 WireGuard 的企业级 SD-WAN 系统任务列表 (TASK.md)

该文档列出了基于 WireGuard 的企业级 SD-WAN 系统的初始开发任务，按照模块分类编写。SD-WAN 系统架构上通常将控制平面与数据平面分离 ￼，并要求具备集中式的配置和管理能力 ￼。WireGuard 本身缺少企业级的用户认证、日志审计等管理功能，因此需要在系统设计中额外实现这些功能 ￼。以下按模块列出各开发任务，每项任务描述简明，可供后续勾选。开发过程中如发现新任务，可记录在“开发中发现”部分。

Controller（控制器）
	•	设计并实现节点注册与认证接口，管理节点接入和配置信息。
	•	设计数据库模型（存储节点、网络拓扑、访问策略、用户等信息）。
	•	实现 WireGuard 配置自动生成与分发逻辑（生成密钥对并输出配置）。
	•	实现网络拓扑与策略管理功能（定义并应用路由策略和访问控制策略）。
	•	开发控制器 RESTful API 接口（供 UI 和节点客户端调用）。
	•	实现控制器高可用与容灾方案（支持主备或集群部署，故障自动切换）。
	•	实现日志审计与监控功能（记录操作日志，收集节点状态与性能指标）。

Agent（节点客户端）
	•	实现节点客户端自动向控制器注册并上报节点信息（如 IP、地理位置等）。
	•	从控制器拉取并应用 WireGuard 配置（安装密钥并启动隧道）。
	•	支持运行时配置同步和更新（在控制器下发新配置后自动刷新本地配置）。
	•	实现节点状态与性能监控上报（上报带宽、延迟、丢包率等指标）。
	•	实现心跳检测与故障切换机制（检测控制器可用性并自动重连或切换备用控制器）。
	•	实现节点日志记录和错误处理（记录异常日志并提供重试机制）。
	•	提供节点侧命令行或 API 接口（配置控制器地址、日志级别等参数）。

UI（Web 管理界面）
	•	设计 UI 原型与导航结构（明确各功能页面的布局和用户流程）。
	•	实现用户登录与权限管理功能（支持不同角色的访问控制）。
	•	实现节点和网络拓扑可视化展示（动态图形化展示网络连接状态）。
	•	实现策略与配置管理界面（可视化编辑网络拓扑、路由和访问策略）。
	•	实现实时监控面板（展示节点状态、链路质量、流量统计、日志等信息）。
	•	与控制器 RESTful API 对接（读取和提交后端数据）。
	•	支持配置导入/导出功能及审计日志查看。

Infra（部署与脚本）
	•	设计系统部署架构（确定部署环境、拓扑和依赖关系）。
	•	编写自动化部署脚本或模板（例如 Docker Compose、Helm Chart、Ansible 等）。
	•	集成持续集成/持续交付流程（CI/CD：自动化构建、测试、部署）。
	•	搭建监控与告警系统（如 Prometheus+Grafana 或 ELK，用于性能监控和日志分析）。
	•	实现日志收集与集中存储（采集控制器和节点日志，便于调试和审计）。
	•	实现数据库与配置文件的定期备份与恢复方案。
	•	编写安全加固脚本（配置防火墙、SSL/TLS、SSH 安全等）。
	•	支持多环境部署（开发、测试、生产环境的配置管理）。

Common（通用工具与类型）
	•	定义通用数据结构（节点、网络、策略等模块公用的类型）。
	•	实现加密与密钥管理模块（WireGuard 密钥对生成、存储和加载）。
	•	实现通用配置解析与生成工具（支持 JSON/YAML 格式的配置读写）。
	•	提供统一日志和错误处理库（标准化日志格式、错误码和异常处理机制）。
	•	开发常用辅助库（参数校验、重试机制、任务调度等工具）。
	•	撰写通用组件文档（说明公共库的使用方式和接口定义）。

Discovered During Work（开发中发现）
	•	开发过程中发现的新任务和需求。

参考资料： 企业 SD-WAN 方案强调集中式控制和平面分离 ￼；企业级 VPN 需要自行实现集中管理、用户认证、日志监控等功能 ￼。